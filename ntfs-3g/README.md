# 漏洞分析
1. 漏洞存在于NTFS-3G之中，该程序是由Tuxera公司开发并维护的开源项目，目的是为Linux提供NTFS分区的驱动程序，实现对NTFS文件系统的读写。该程序默认安装在Ubuntu等操作系统中，并且赋予了setuid的权限。NTFS-3G在调用modprobe时没有初始化环境变量，致使存在本地提权的风险。
2. FUSE（用户空间文件系统）作为类UNIX系统平台上可加载的内核模块，允许非特权用户创建功能完备的文件系统，而不需要重新编译内核。FUSE模块仅仅提供kernel模块的接入口，而本身的主要实现代码位于用户空间中,这些接口需要用户自己去实现。
3. 在NTFS-3G驱动模块中，该模块被调用时，即执行src/ntfs-3g.c文件中的main函数，其中一块的代码如下：
    ``` 
        fstype = get_fuse_fstype();
        err = NTFS_VOLUME_NO_PRIVILEGE;
        if (restore_privs())
            goto err_out;
        if (fstype == FSTYPE_NONE || fstype == FSTYPE_UNKNOWN)
            fstype = load_fuse_module();
    ```
4. 代码意思为：利用get_fuse_fstype()检测当前系统是否加载FUSE模块，若未加载，则利用load_fuse_module()中的modprobe，加载FUSE模块。
5. get_fuse_fstype函数：
    ```
    static fuse_fstype get_fuse_fstype(void)                                              
    {
        char buf[256];
        fuse_fstype fstype = FSTYPE_NONE;
        FILE *f = fopen("/proc/filesystems", "r");
        if (!f) {
            ntfs_log_perror("Failed to open /proc/filesystems");
            return FSTYPE_UNKNOWN;
        }
        while (fgets(buf, sizeof(buf), f)) {
            if (strstr(buf, "fuseblk\n")) {
                fstype = FSTYPE_FUSEBLK;
                break;
            }
            if (strstr(buf, "fuse\n"))
                fstype = FSTYPE_FUSE;
        }
        fclose(f);
        return fstype;
    }
```
# 参考
 [简书CVE-2017-0358](http://www.jianshu.com/p/5bb3fc02ce23)